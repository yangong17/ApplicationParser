
{% extends "layout.html" %}

{% block content %}


<h2>Form Parser V1.0</h2>

<hr>  
<!-- ============================================================================================================================================== -->

<!-- Upload Forms -->
<form action="/upload" style="margin-top: 40px; margin-bottom: 40px;" method="post" enctype="multipart/form-data" onsubmit="return confirmUpload()">
    
    <h4 style="margin-top: 40px; margin-bottom: 40px;">1. Upload Forms</h4>

    <!-- Dropdown for Template Selection -->
    <div class="form-group">
        <label for="templateSelection">Select Form Template:</label>
        <select class="form-control" id="templateSelection" name="template">
            <option value="manufacturingTemplate1">Manufacturing Job Application 1</option>
        </select>
    </div>

    <!-- Buttons for Download and Preview -->
    <div class="form-group">
        <a href="{{ url_for('static', filename='form_templates/General Job Application - Blank.pdf') }}" download class="btn btn-primary">Download Template</a>
        <a href="{{ url_for('static', filename='form_templates/General Job Application - Blank.pdf') }}" target="_blank" class="btn btn-secondary">Preview</a>
    </div>

    <br>


    <!-- Upload PDF -->
    <div class="form-group">
        <input type="file" class="form-control-file" id="pdf" name="file" accept=".pdf">
    </div>
    <!-- Submit Button for Upload -->
    <input type="submit" name="upload" value="Upload" class="btn btn-success">

</form>

<script>
    function confirmUpload() {
        var selectedTemplate = document.getElementById("templateSelection");
        var selectedText = selectedTemplate.options[selectedTemplate.selectedIndex].text;
        return confirm("Click OK to confirm upload. Ensure that the form template matches the chosen files (" + selectedText + ")");
    }
</script>

<!-- Confirmation Message -->
{% if uploadmsg %}
<p class="alert alert-success mt-3">{{ uploadmsg }}</p>
<script>
    $("#pdf").attr("disabled", "disabled");  // Disable the file input
    $("input[type='submit']").attr("disabled", "disabled");  // Disable the upload button
</script>
{% endif %}

<hr>
<!-- ============================================================================================================================================== -->

<form action="/execute" style="margin-top: 40px; margin-bottom: 40px;" method="post" enctype="multipart/form-data">
   
    <h4 style="margin-top: 40px; margin-bottom: 40px;">2. Analyze with Amazon Textract</h4>

    <!-- Button to run Analysis -->
    <button id="executeBtn">Analyze</button>

</form>

<!-- Confirmation Message -->
{% if executemsg %}
<p class="alert alert-success mt-3">{{ executemsg }}</p>
{% endif %}

<hr> 
<!-- ============================================================================================================================================== -->

<div class="row">
    
    <!-- Review Data -->
    <div class="col-md-6">
        <form action="/analyze" style="margin-top: 40px; margin-bottom: 40px;" method="post" enctype="multipart/form-data">
            <h4>View Database</h4>
            <!-- Button to view database data -->
            <button id="analyzeBtn" type="button" class="btn btn-secondary mt-3">View Database</button>
        </form>

        <button id="sortBtn" type="button" class="btn btn-secondary mt-3">Sort by Match Count</button>

        <!-- Placeholder for the extracted data table -->
        <div id="dataTableContainer" style="margin-top: 40px; margin-bottom: 40px;">
            <h4>Extracted Data:</h4>
            <table class="table table-bordered" id="extractedDataTable">
                <thead>
                    <tr>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Years of Experience</th>
                        <th>Relevant Skills</th>
                        <th>Match Count</th>
                        <th>Matched Skills</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Filter Results -->
    <div class="col-md-6">
        <form action="/filter" style="margin-top: 40px; margin-bottom: 40px;" method="post">
            <h4>3. Filter Results</h4>
            <p>Enter details of job to compare applications to:</p>

            <div>
                <label for="yearsOfExperience">Years of Experience:</label>
                <input type="number" id="yearsOfExperience" name="yearsOfExperience" placeholder="e.g: 5" required>
            </div>

            <div>
                <label for="salary">Annual Compensation:</label>
                <input type="number" id="salary" name="salary" placeholder="e.g: 65000" required>
            </div>

            <div>
                <label for="keyWords">Job Duties and Responsibilties:</label><br>
                <textarea id="keyWords" name="keyWords" rows="4" cols="50" required></textarea>
            </div>

            <div>
                <input type="submit" value="Submit">
            </div>
        </form>
    
        <!-- Confirmation Message -->
        {% if infomsg %}
        <p class="alert alert-success mt-3">{{ infomsg }}</p>
        {% endif %}

    </div>
</div>

<script>
    $(document).ready(function(){
        let currentData = [];  // Store the retrieved data for sorting

        $("#analyzeBtn").click(function(event){
            // ... (Your existing code)

            // Send a POST request to /analyze
            $.post("/analyze", function(data){
                currentData = data;  // Store the data

                // Clear the existing rows in the table
                $("#extractedDataTable tbody").empty();

                populateTable(currentData);  // Use a function to populate the table
            });
        });

        // CHANGES MADE HERE: Added a click handler for the sort button
        $("#sortBtn").click(function(){
            if(currentData && currentData.length) {
                // Sort the data by match_count (highest first)
                let sortedData = currentData.sort((a, b) => b.match_count - a.match_count);

                // Clear the existing rows in the table
                $("#extractedDataTable tbody").empty();

                populateTable(sortedData);  // Use the same function to populate the table with sorted data
            }
        });

        // CHANGES MADE HERE: Extracted table populating code into a separate function for reusability
        function populateTable(data) {
            // Loop through each row of data
            $.each(data, function(index, row){
                // Create a new table row
                let tr = $("<tr>");
                
                // Append columns to the row
                tr.append($("<td>").text(row.first_name));
                tr.append($("<td>").text(row.last_name));
                tr.append($("<td>").text(row.years_of_experience));
                tr.append($("<td>").text(row.your_relevant_skills));
                tr.append($("<td>").text(row.match_count));
                tr.append($("<td>").text(row.matched_skills));  

                // Append the row to the table body
                $("#extractedDataTable tbody").append(tr);
            });
        }
    });
</script>


<!-- Download File Button -->
<div class="mt-3">
    <a href="/download/filename_here" class="btn btn-success">Download Processed File</a>
</div>



{% endblock %}
